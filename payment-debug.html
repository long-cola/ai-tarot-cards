<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ”¯ä»˜é—®é¢˜è¯Šæ–­å·¥å…·</title>
  <style>
    body { font-family: Arial, sans-serif; background: #0f172a; color: #e2e8f0; margin: 0; padding: 16px; max-width: 800px; margin: 0 auto; }
    h1 { font-size: 24px; margin-bottom: 16px; color: #22d3ee; }
    h2 { font-size: 18px; margin-top: 24px; margin-bottom: 12px; color: #a78bfa; }
    .card { background: #111827; border: 1px solid #1f2937; border-radius: 12px; padding: 16px; margin-bottom: 16px; }
    input, button { padding: 8px; border: 1px solid #334155; border-radius: 6px; background: #1e293b; color: #e2e8f0; }
    button { cursor: pointer; background: #3b82f6; font-weight: bold; }
    button:hover { background: #2563eb; }
    button.danger { background: #dc2626; }
    button.danger:hover { background: #b91c1c; }
    .flex { display: flex; gap: 8px; align-items: center; }
    .info { background: #1e3a8a; padding: 12px; border-radius: 8px; margin: 12px 0; border-left: 4px solid #3b82f6; }
    .warning { background: #854d0e; padding: 12px; border-radius: 8px; margin: 12px 0; border-left: 4px solid #eab308; }
    .error { background: #7f1d1d; padding: 12px; border-radius: 8px; margin: 12px 0; border-left: 4px solid #dc2626; }
    .success { background: #14532d; padding: 12px; border-radius: 8px; margin: 12px 0; border-left: 4px solid #22c55e; }
    pre { white-space: pre-wrap; word-break: break-all; background: #0b1220; padding: 12px; border-radius: 8px; font-size: 12px; }
    code { background: #1e293b; padding: 2px 6px; border-radius: 4px; font-family: monospace; color: #22d3ee; }
    .step { background: #1e293b; padding: 12px; border-radius: 8px; margin: 8px 0; border-left: 4px solid #22d3ee; }
    .step-number { background: #22d3ee; color: #0f172a; width: 24px; height: 24px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; font-weight: bold; margin-right: 8px; }
  </style>
</head>
<body>
  <h1>ğŸ’³ æ”¯ä»˜é—®é¢˜è¯Šæ–­å·¥å…·</h1>

  <div class="info">
    <strong>ğŸ¯ ä½¿ç”¨è¯´æ˜ï¼š</strong>
    <p>å¦‚æœæ‚¨å®Œæˆæ”¯ä»˜ä½†æœªè‡ªåŠ¨å‡çº§ä¸º Pro ä¼šå‘˜ï¼Œè¯·æŒ‰ä»¥ä¸‹æ­¥éª¤æ’æŸ¥é—®é¢˜ã€‚</p>
  </div>

  <!-- Step 1: Check User Status -->
  <div class="card">
    <h2>æ­¥éª¤ 1: æ£€æŸ¥ç”¨æˆ·çŠ¶æ€</h2>
    <div class="step">
      <span class="step-number">1</span>
      è¯·å…ˆç™»å½•ï¼Œç„¶åç‚¹å‡»ä¸‹æ–¹æŒ‰é’®æ£€æŸ¥æ‚¨å½“å‰çš„ä¼šå‘˜çŠ¶æ€
    </div>
    <button onclick="checkUserStatus()">æ£€æŸ¥æˆ‘çš„ä¼šå‘˜çŠ¶æ€</button>
    <div id="userStatus"></div>
  </div>

  <!-- Step 2: Check Webhook Logs -->
  <div class="card">
    <h2>æ­¥éª¤ 2: æ£€æŸ¥ Webhook é…ç½®</h2>
    <div class="warning">
      <strong>âš ï¸ å¸¸è§é—®é¢˜ï¼š</strong> Webhook å¯èƒ½æœªæ­£ç¡®é…ç½®æˆ–æœªè¢«è§¦å‘
    </div>
    <div class="step">
      <span class="step-number">2</span>
      è¯·è®¿é—® Creem Dashboard æ£€æŸ¥ Webhook é…ç½®
    </div>
    <div style="margin: 12px 0;">
      <p>1. ç™»å½• <a href="https://app.creem.io/settings/webhooks" target="_blank" style="color: #22d3ee;">Creem Dashboard â†’ Webhooks</a></p>
      <p>2. ç¡®è®¤ Webhook URL ä¸ºï¼š<code>https://ai-tarotcard.com/api/creem-webhook</code></p>
      <p>3. ç¡®è®¤å·²è®¢é˜…äº‹ä»¶ï¼š<code>order.completed</code></p>
      <p>4. æŸ¥çœ‹ Webhook å‘é€å†å²ï¼Œç¡®è®¤æ˜¯å¦æˆåŠŸå‘é€</p>
    </div>
  </div>

  <!-- Step 3: Manual Upgrade -->
  <div class="card">
    <h2>æ­¥éª¤ 3: æ‰‹åŠ¨æ¿€æ´»ä¼šå‘˜ï¼ˆä»…ç®¡ç†å‘˜ï¼‰</h2>
    <div class="warning">
      <strong>âš ï¸ ç®¡ç†å‘˜åŠŸèƒ½ï¼š</strong> åªæœ‰ç®¡ç†å‘˜æ‰èƒ½ä½¿ç”¨æ­¤åŠŸèƒ½
    </div>
    <div class="step">
      <span class="step-number">3</span>
      å¦‚æœ Webhook æœªè§¦å‘ï¼Œç®¡ç†å‘˜å¯ä»¥æ‰‹åŠ¨æ¿€æ´»ä¼šå‘˜æƒé™
    </div>
    <div style="margin: 12px 0;">
      <div class="flex">
        <input id="adminEmail" type="text" placeholder="ç®¡ç†å‘˜é‚®ç®±" style="flex:1;">
        <input id="adminPassword" type="password" placeholder="ç®¡ç†å‘˜å¯†ç " style="flex:1;">
      </div>
      <div class="flex" style="margin-top: 8px;">
        <input id="targetUserId" type="text" placeholder="ç”¨æˆ· ID (UUID)" style="flex:1;">
        <button onclick="manualUpgrade()">æ‰‹åŠ¨æ¿€æ´»ä¼šå‘˜</button>
      </div>
    </div>
    <div id="manualUpgradeResult"></div>
  </div>

  <!-- Step 4: View Recent Webhooks (Admin) -->
  <div class="card">
    <h2>æ­¥éª¤ 4: æŸ¥çœ‹ Webhook å†å²ï¼ˆä»…ç®¡ç†å‘˜ï¼‰</h2>
    <div class="step">
      <span class="step-number">4</span>
      æŸ¥çœ‹æœ€è¿‘çš„ Webhook äº‹ä»¶è®°å½•
    </div>
    <button onclick="viewWebhookLogs()">æŸ¥çœ‹ Webhook æ—¥å¿—</button>
    <div id="webhookLogs"></div>
  </div>

  <!-- Troubleshooting Guide -->
  <div class="card">
    <h2>ğŸ“š å¸¸è§é—®é¢˜è§£å†³æ–¹æ¡ˆ</h2>

    <div class="step">
      <strong>Q1: æ”¯ä»˜æˆåŠŸä½†æ²¡æœ‰å‡çº§ï¼Ÿ</strong>
      <p>A: è¿™é€šå¸¸æ˜¯å› ä¸º Webhook æœªè¢« Creem è°ƒç”¨ã€‚è¯·æ£€æŸ¥ Creem Dashboard ä¸­çš„ Webhook é…ç½®å’Œå‘é€å†å²ã€‚</p>
    </div>

    <div class="step">
      <strong>Q2: Webhook URL æ˜¯å¦æ­£ç¡®ï¼Ÿ</strong>
      <p>A: ç¡®ä¿ Webhook URL ä¸º <code>https://ai-tarotcard.com/api/creem-webhook</code>ï¼ˆæ— æ–œæ ç»“å°¾ï¼‰</p>
    </div>

    <div class="step">
      <strong>Q3: æµ‹è¯•ç¯å¢ƒ vs ç”Ÿäº§ç¯å¢ƒ</strong>
      <p>A: ç¡®ä¿ä½¿ç”¨åŒä¸€ç¯å¢ƒçš„ API Key å’Œ Product IDï¼ˆéƒ½æ˜¯æµ‹è¯•æˆ–éƒ½æ˜¯ç”Ÿäº§ï¼‰</p>
    </div>

    <div class="step">
      <strong>Q4: å¦‚ä½•è”ç³»æŠ€æœ¯æ”¯æŒï¼Ÿ</strong>
      <p>A: è¯·è®°å½•æ‚¨çš„ç”¨æˆ· ID å’Œæ”¯ä»˜æ—¶é—´ï¼Œå‘é€é‚®ä»¶è‡³ support@ai-tarotcard.com</p>
    </div>
  </div>

  <script>
    async function checkUserStatus() {
      const resultDiv = document.getElementById('userStatus');
      resultDiv.innerHTML = '<p>æ­£åœ¨æ£€æŸ¥...</p>';

      try {
        const response = await fetch('/api/me');
        if (!response.ok) {
          throw new Error('æœªç™»å½•æˆ–è¯·æ±‚å¤±è´¥');
        }

        const data = await response.json();
        const user = data.user;
        const plan = data.plan;

        const expiresAt = user.membership_expires_at
          ? new Date(user.membership_expires_at).toLocaleString('zh-CN')
          : 'æ— ';

        const isPro = plan === 'member' || plan === 'pro' || (user.membership_expires_at && new Date(user.membership_expires_at) > new Date());

        if (isPro) {
          resultDiv.innerHTML = `
            <div class="success">
              <strong>âœ… æ‚¨å·²ç»æ˜¯ Pro ä¼šå‘˜ï¼</strong>
              <p>ç”¨æˆ· ID: <code>${user.id}</code></p>
              <p>é‚®ç®±: ${user.email}</p>
              <p>ä¼šå‘˜åˆ°æœŸ: ${expiresAt}</p>
            </div>
          `;
        } else {
          resultDiv.innerHTML = `
            <div class="warning">
              <strong>âš ï¸ æ‚¨å½“å‰æ˜¯å…è´¹ç”¨æˆ·</strong>
              <p>ç”¨æˆ· ID: <code>${user.id}</code></p>
              <p>é‚®ç®±: ${user.email}</p>
              <p>ä¼šå‘˜åˆ°æœŸ: ${expiresAt}</p>
              <p style="margin-top:12px;">å¦‚æœæ‚¨å·²å®Œæˆæ”¯ä»˜ï¼Œè¯·ç»§ç»­ä¸‹é¢çš„æ­¥éª¤æ’æŸ¥é—®é¢˜ã€‚</p>
            </div>
          `;
        }
      } catch (error) {
        resultDiv.innerHTML = `
          <div class="error">
            <strong>âŒ æ£€æŸ¥å¤±è´¥</strong>
            <p>${error.message}</p>
            <p>è¯·ç¡®ä¿æ‚¨å·²ç™»å½•ã€‚</p>
          </div>
        `;
      }
    }

    async function manualUpgrade() {
      const email = document.getElementById('adminEmail').value;
      const password = document.getElementById('adminPassword').value;
      const userId = document.getElementById('targetUserId').value;
      const resultDiv = document.getElementById('manualUpgradeResult');

      if (!email || !password || !userId) {
        resultDiv.innerHTML = '<div class="error">è¯·å¡«å†™æ‰€æœ‰å­—æ®µ</div>';
        return;
      }

      resultDiv.innerHTML = '<p>æ­£åœ¨å¤„ç†...</p>';

      try {
        const response = await fetch('/api/test-webhook', {
          method: 'POST',
          headers: {
            'Authorization': 'Basic ' + btoa(`${email}:${password}`),
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ userId })
        });

        if (!response.ok) {
          throw new Error(`è¯·æ±‚å¤±è´¥ (${response.status})`);
        }

        const data = await response.json();

        resultDiv.innerHTML = `
          <div class="success">
            <strong>âœ… ä¼šå‘˜æ¿€æ´»æˆåŠŸï¼</strong>
            <p>ç”¨æˆ· ID: <code>${data.userId}</code></p>
            <p>åˆ°æœŸæ—¶é—´: ${new Date(data.endsAt).toLocaleString('zh-CN')}</p>
            <p style="margin-top:12px;">è¯·è®©ç”¨æˆ·åˆ·æ–°é¡µé¢æŸ¥çœ‹ä¼šå‘˜çŠ¶æ€ã€‚</p>
          </div>
        `;
      } catch (error) {
        resultDiv.innerHTML = `
          <div class="error">
            <strong>âŒ æ¿€æ´»å¤±è´¥</strong>
            <p>${error.message}</p>
            <p>è¯·æ£€æŸ¥ç®¡ç†å‘˜å‡­æ®å’Œç”¨æˆ· ID æ˜¯å¦æ­£ç¡®ã€‚</p>
          </div>
        `;
      }
    }

    async function viewWebhookLogs() {
      const resultDiv = document.getElementById('webhookLogs');
      resultDiv.innerHTML = `
        <div class="info">
          <p>Webhook æ—¥å¿—å­˜å‚¨åœ¨ Vercel å‡½æ•°æ—¥å¿—ä¸­ã€‚</p>
          <p>è¯·è®¿é—® <a href="https://vercel.com/dashboard" target="_blank" style="color: #22d3ee;">Vercel Dashboard</a> â†’ é¡¹ç›® â†’ Deployments â†’ æœ€æ–°éƒ¨ç½² â†’ Functions â†’ æŸ¥çœ‹ <code>api/creem-webhook</code> çš„æ—¥å¿—</p>
          <p>æ—¥å¿—æ ¼å¼ç¤ºä¾‹ï¼š</p>
          <pre>[Creem Webhook] Received webhook
[Creem Webhook] Event type: order.completed
[Creem Webhook] Granting membership: {...}
[Creem Webhook] Membership granted successfully</pre>
        </div>
      `;
    }
  </script>
</body>
</html>
