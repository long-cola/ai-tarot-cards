<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard</title>
  <style>
    body { font-family: Arial, sans-serif; background: #0f172a; color: #e2e8f0; margin: 0; padding: 16px; }
    h1 { font-size: 20px; margin-bottom: 12px; }
    table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
    th, td { border: 1px solid #334155; padding: 8px; font-size: 12px; }
    th { background: #1e293b; }
    tr:nth-child(every) { background: #0f172a; }
    input, button { padding: 8px; border: 1px solid #334155; border-radius: 6px; background: #1e293b; color: #e2e8f0; }
    button { cursor: pointer; }
    .card { background: #111827; border: 1px solid #1f2937; border-radius: 12px; padding: 12px; margin-bottom: 16px; }
    .flex { display: flex; gap: 8px; align-items: center; }
    .mt { margin-top: 8px; }
    pre { white-space: pre-wrap; word-break: break-all; background: #0b1220; padding: 8px; border-radius: 8px; }
    code { background: #1e293b; padding: 2px 6px; border-radius: 4px; font-family: monospace; color: #22d3ee; }
  </style>
</head>
<body>
  <div class="card">
    <h1>Admin Dashboard</h1>
    <div class="flex">
      <input id="email" type="text" placeholder="é‚®ç®±" value="catadioptric19941@gmail.com" style="flex:1;">
      <input id="password" type="password" placeholder="å¯†ç " value="Admin123456" style="flex:1;">
      <button onclick="loadUsers()">ç™»å½•å¹¶åŠ è½½ç”¨æˆ·</button>
      <button onclick="loadCodes()">åŠ è½½å…‘æ¢ç </button>
    </div>
  </div>

  <div id="codes" class="card" style="display:none;">
    <h2 style="font-size:16px;">å…‘æ¢ç ç®¡ç†</h2>

    <div class="card" style="background:#0f172a;margin-bottom:12px;">
      <h3 style="font-size:14px;margin-bottom:8px;">ç”Ÿæˆæ–°å…‘æ¢ç </h3>
      <div class="flex">
        <input id="codeCount" type="number" placeholder="æ•°é‡" value="1" min="1" max="50" style="width:80px;">
        <input id="codeDurationDays" type="number" placeholder="ä¼šå‘˜å¤©æ•°" value="30" min="1" style="width:100px;">
        <input id="codeValidDays" type="number" placeholder="æœ‰æ•ˆæœŸ(å¤©)" value="365" min="1" style="width:100px;">
        <button onclick="generateCodes()">ç”Ÿæˆå…‘æ¢ç </button>
      </div>
      <div id="generatedCodes" class="mt" style="display:none;">
        <strong>ç”Ÿæˆçš„å…‘æ¢ç ï¼š</strong>
        <pre id="generatedCodesList" style="margin-top:4px;"></pre>
      </div>
    </div>

    <div id="codeCount"></div>
    <table id="codeTable">
      <thead>
        <tr>
          <th>å…‘æ¢ç </th>
          <th>çŠ¶æ€</th>
          <th>ä¼šå‘˜å¤©æ•°</th>
          <th>æœ‰æ•ˆæœŸè‡³</th>
          <th>ä½¿ç”¨è€…</th>
          <th>ä½¿ç”¨æ—¶é—´</th>
          <th>åˆ›å»ºæ—¶é—´</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div id="users" class="card">
    <h2 style="font-size:16px;">ç”¨æˆ·åˆ—è¡¨</h2>
    <div id="userCount"></div>
    <table id="userTable">
      <thead>
        <tr>
          <th>ID</th>
          <th>Email</th>
          <th>Plan</th>
          <th>åˆ°æœŸ</th>
          <th>æ³¨å†Œæ—¶é—´</th>
          <th>å‘½é¢˜æ•°</th>
          <th>äº‹ä»¶æ•°</th>
          <th>æ“ä½œ</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div id="topics" class="card" style="display:none;">
    <h2 style="font-size:16px;">ç”¨æˆ·å‘½é¢˜</h2>
    <table id="topicTable">
      <thead>
        <tr>
          <th>æ ‡é¢˜</th>
          <th>åˆ›å»ºæ—¶é—´</th>
          <th>äº‹ä»¶æ•°</th>
          <th>æŸ¥çœ‹äº‹ä»¶</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div id="events" class="card" style="display:none;">
    <h2 style="font-size:16px;">å‘½é¢˜äº‹ä»¶</h2>
    <table id="eventTable">
      <thead>
        <tr>
          <th>åç§°</th>
          <th>æ—¶é—´</th>
          <th>ç‰Œ</th>
          <th>è§£è¯»</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
    const api = async (path) => {
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      const headers = {
        'Authorization': 'Basic ' + btoa(`${email}:${password}`)
      };
      const response = await fetch(path, { headers });

      if (!response.ok) {
        const error = await response.text();
        throw new Error(`è¯·æ±‚å¤±è´¥ (${response.status}): ${error}`);
      }

      return response.json();
    };

    async function loadUsers() {
      try {
        const data = await api('/api/admin/users');
        const tbody = document.querySelector('#userTable tbody');
        tbody.innerHTML = '';
        document.getElementById('userCount').innerText = `æ€»ç”¨æˆ·ï¼š${data.total || 0}`;
        (data.users || []).forEach(u => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${u.id}</td>
            <td>${u.email || ''}</td>
            <td>${u.plan}</td>
            <td>${u.membership_expires_at || ''}</td>
            <td>${u.created_at || ''}</td>
            <td>${u.topic_count || 0}</td>
            <td>${u.event_count || 0}</td>
            <td><button data-id="${u.id}">æŸ¥çœ‹å‘½é¢˜</button></td>
          `;
          tr.querySelector('button').onclick = () => loadTopics(u.id);
          tbody.appendChild(tr);
        });
        // ç™»å½•æˆåŠŸåæ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯å’Œç”¨æˆ·åˆ—è¡¨
        document.getElementById('users').style.display = 'block';
        document.getElementById('codes').style.display = 'none';
        console.log('ç™»å½•æˆåŠŸï¼Œå·²åŠ è½½ç”¨æˆ·åˆ—è¡¨');
      } catch (error) {
        console.error('åŠ è½½å¤±è´¥:', error);
        alert('ç™»å½•å¤±è´¥ï¼š' + error.message + '\nè¯·æ£€æŸ¥é‚®ç®±å’Œå¯†ç æ˜¯å¦æ­£ç¡®');
        document.querySelector('#userTable tbody').innerHTML = '<tr><td colspan="8">ç™»å½•å¤±è´¥ï¼Œè¯·é‡æ–°è¾“å…¥æ­£ç¡®çš„é‚®ç®±å’Œå¯†ç </td></tr>';
      }
    }

    async function loadTopics(userId) {
      try {
        const data = await api(`/api/admin/users/${userId}/topics`);
        const tbody = document.querySelector('#topicTable tbody');
        tbody.innerHTML = '';
        (data.topics || []).forEach(t => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${t.title}</td>
            <td>${t.created_at || ''}</td>
            <td>${t.event_count || 0}</td>
            <td><button data-id="${t.id}">æŸ¥çœ‹</button></td>
          `;
          tr.querySelector('button').onclick = () => loadEvents(t.id);
          tbody.appendChild(tr);
        });
        document.getElementById('topics').style.display = 'block';
        document.getElementById('events').style.display = 'none';
      } catch (error) {
        console.error('åŠ è½½å‘½é¢˜å¤±è´¥:', error);
        alert('åŠ è½½å‘½é¢˜å¤±è´¥ï¼š' + error.message);
      }
    }

    async function loadEvents(topicId) {
      try {
        const data = await api(`/api/admin/topics/${topicId}/events`);
        const tbody = document.querySelector('#eventTable tbody');
        tbody.innerHTML = '';
        (data.events || []).forEach(e => {
          const cards = (e.cards || []).map(c => c.name || c.nameCn || '').join(', ');
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${e.name}</td>
            <td>${e.created_at || ''}</td>
            <td>${cards}</td>
            <td><pre>${e.reading || ''}</pre></td>
          `;
          tbody.appendChild(tr);
        });
        document.getElementById('events').style.display = 'block';
      } catch (error) {
        console.error('åŠ è½½äº‹ä»¶å¤±è´¥:', error);
        alert('åŠ è½½äº‹ä»¶å¤±è´¥ï¼š' + error.message);
      }
    }

    async function loadCodes() {
      try {
        const data = await api('/api/admin/codes');
        const tbody = document.querySelector('#codeTable tbody');
        tbody.innerHTML = '';

        const stats = { total: 0, active: 0, used: 0, expired: 0 };
        (data.codes || []).forEach(c => {
          stats.total++;
          stats[c.status]++;

          const statusText = {
            active: 'ğŸŸ¢ å¯ç”¨',
            used: 'ğŸ”´ å·²ä½¿ç”¨',
            expired: 'âš« å·²è¿‡æœŸ'
          }[c.status] || c.status;

          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td><code>${c.code}</code></td>
            <td>${statusText}</td>
            <td>${c.duration_days} å¤©</td>
            <td>${c.expires_at ? new Date(c.expires_at).toLocaleDateString('zh-CN') : 'æ°¸ä¹…'}</td>
            <td>${c.redeemed_by_email || '-'}</td>
            <td>${c.redeemed_at ? new Date(c.redeemed_at).toLocaleString('zh-CN') : '-'}</td>
            <td>${new Date(c.created_at).toLocaleString('zh-CN')}</td>
          `;
          tbody.appendChild(tr);
        });

        document.getElementById('codeCount').innerText =
          `æ€»è®¡ï¼š${stats.total} | å¯ç”¨ï¼š${stats.active} | å·²ä½¿ç”¨ï¼š${stats.used} | å·²è¿‡æœŸï¼š${stats.expired}`;

        document.getElementById('codes').style.display = 'block';
        document.getElementById('users').style.display = 'none';
        console.log('å…‘æ¢ç åŠ è½½æˆåŠŸ');
      } catch (error) {
        console.error('åŠ è½½å…‘æ¢ç å¤±è´¥:', error);
        alert('åŠ è½½å…‘æ¢ç å¤±è´¥ï¼š' + error.message);
      }
    }

    async function generateCodes() {
      try {
        const count = parseInt(document.getElementById('codeCount').value) || 1;
        const durationDays = parseInt(document.getElementById('codeDurationDays').value) || 30;
        const validDays = parseInt(document.getElementById('codeValidDays').value) || 365;

        if (count < 1 || count > 50) {
          alert('æ•°é‡å¿…é¡»åœ¨ 1-50 ä¹‹é—´');
          return;
        }

        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        const headers = {
          'Authorization': 'Basic ' + btoa(`${email}:${password}`),
          'Content-Type': 'application/json'
        };

        const response = await fetch('/api/admin/codes/generate', {
          method: 'POST',
          headers,
          body: JSON.stringify({ count, durationDays, validDays })
        });

        if (!response.ok) {
          throw new Error(`ç”Ÿæˆå¤±è´¥ (${response.status})`);
        }

        const data = await response.json();

        // æ˜¾ç¤ºç”Ÿæˆçš„å…‘æ¢ç 
        const generatedDiv = document.getElementById('generatedCodes');
        const codesList = document.getElementById('generatedCodesList');
        codesList.textContent = data.codes.join('\n');
        generatedDiv.style.display = 'block';

        alert(`æˆåŠŸç”Ÿæˆ ${data.codes.length} ä¸ªå…‘æ¢ç ï¼`);

        // é‡æ–°åŠ è½½åˆ—è¡¨
        loadCodes();
      } catch (error) {
        console.error('ç”Ÿæˆå…‘æ¢ç å¤±è´¥:', error);
        alert('ç”Ÿæˆå…‘æ¢ç å¤±è´¥ï¼š' + error.message);
      }
    }
  </script>
</body>
</html>
