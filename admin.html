<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard</title>
  <style>
    body { font-family: Arial, sans-serif; background: #0f172a; color: #e2e8f0; margin: 0; padding: 16px; }
    h1 { font-size: 20px; margin-bottom: 12px; }
    table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
    th, td { border: 1px solid #334155; padding: 8px; font-size: 12px; }
    th { background: #1e293b; }
    tr:nth-child(every) { background: #0f172a; }
    input, button { padding: 8px; border: 1px solid #334155; border-radius: 6px; background: #1e293b; color: #e2e8f0; }
    button { cursor: pointer; }
    .card { background: #111827; border: 1px solid #1f2937; border-radius: 12px; padding: 12px; margin-bottom: 16px; }
    .flex { display: flex; gap: 8px; align-items: center; }
    .mt { margin-top: 8px; }
    pre { white-space: pre-wrap; word-break: break-all; background: #0b1220; padding: 8px; border-radius: 8px; }
    code { background: #1e293b; padding: 2px 6px; border-radius: 4px; font-family: monospace; color: #22d3ee; }
  </style>
</head>
<body>
  <div class="card">
    <h1>Admin Dashboard</h1>
    <div class="flex">
      <input id="email" type="text" placeholder="é‚®ç®±" style="flex:1;">
      <input id="password" type="password" placeholder="å¯†ç " style="flex:1;">
      <button onclick="loadAnalytics()">ç»Ÿè®¡æ•°æ®</button>
      <button onclick="loadUsers()">ç”¨æˆ·åˆ—è¡¨</button>
      <button onclick="loadCodes()">å…‘æ¢ç </button>
      <button onclick="loadPrompts()">Prompts</button>
    </div>
  </div>

  <div id="analytics" class="card" style="display:none;">
    <h2 style="font-size:16px;">ç»Ÿè®¡æ•°æ®</h2>
    <div class="flex" style="margin-bottom:12px;">
      <select id="analyticsRangeDays" style="width:150px;">
        <option value="7">æœ€è¿‘ 7 å¤©</option>
        <option value="30" selected>æœ€è¿‘ 30 å¤©</option>
        <option value="90">æœ€è¿‘ 90 å¤©</option>
      </select>
      <button onclick="loadAnalytics()">åˆ·æ–°</button>
    </div>

    <div id="analyticsSummary" class="card" style="background:#0f172a;margin-bottom:12px;">
      <h3 style="font-size:14px;margin-bottom:8px;">æ€»è§ˆ</h3>
      <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;">
        <div>
          <div style="font-size:10px;color:#94a3b8;">é¡µé¢è®¿é—®</div>
          <div id="totalPageViews" style="font-size:20px;font-weight:bold;color:#22d3ee;">-</div>
        </div>
        <div>
          <div style="font-size:10px;color:#94a3b8;">ç‹¬ç«‹è®¿å®¢</div>
          <div id="totalUniqueVisitors" style="font-size:20px;font-weight:bold;color:#22d3ee;">-</div>
        </div>
        <div>
          <div style="font-size:10px;color:#94a3b8;">æ–°ç”¨æˆ·</div>
          <div id="totalNewUsers" style="font-size:20px;font-weight:bold;color:#a78bfa;">-</div>
        </div>
        <div>
          <div style="font-size:10px;color:#94a3b8;">å åœæ¬¡æ•°</div>
          <div id="totalBaselineReadings" style="font-size:20px;font-weight:bold;color:#f472b6;">-</div>
        </div>
        <div>
          <div style="font-size:10px;color:#94a3b8;">äº‹ä»¶æ¬¡æ•°</div>
          <div id="totalEventReadings" style="font-size:20px;font-weight:bold;color:#fb923c;">-</div>
        </div>
        <div>
          <div style="font-size:10px;color:#94a3b8;">æ–°å‘½é¢˜</div>
          <div id="totalNewTopics" style="font-size:20px;font-weight:bold;color:#4ade80;">-</div>
        </div>
      </div>
    </div>

    <table id="analyticsTable">
      <thead>
        <tr>
          <th>æ—¥æœŸ</th>
          <th>é¡µé¢è®¿é—®</th>
          <th>ç‹¬ç«‹è®¿å®¢</th>
          <th>å åœ</th>
          <th>äº‹ä»¶</th>
          <th>æ–°ç”¨æˆ·</th>
          <th>æ–°å‘½é¢˜</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div id="codes" class="card" style="display:none;">
    <h2 style="font-size:16px;">å…‘æ¢ç ç®¡ç†</h2>

    <div class="card" style="background:#0f172a;margin-bottom:12px;">
      <h3 style="font-size:14px;margin-bottom:8px;">ç”Ÿæˆæ–°å…‘æ¢ç </h3>
      <div class="flex">
        <input id="codeCount" type="number" placeholder="æ•°é‡" value="1" min="1" max="50" style="width:80px;">
        <input id="codeDurationDays" type="number" placeholder="ä¼šå‘˜å¤©æ•°" value="30" min="1" style="width:100px;">
        <input id="codeValidDays" type="number" placeholder="æœ‰æ•ˆæœŸ(å¤©)" value="365" min="1" style="width:100px;">
        <button onclick="generateCodes()">ç”Ÿæˆå…‘æ¢ç </button>
      </div>
      <div id="generatedCodes" class="mt" style="display:none;">
        <strong>ç”Ÿæˆçš„å…‘æ¢ç ï¼š</strong>
        <pre id="generatedCodesList" style="margin-top:4px;"></pre>
      </div>
    </div>

    <div id="codeCount"></div>
    <table id="codeTable">
      <thead>
        <tr>
          <th>å…‘æ¢ç </th>
          <th>çŠ¶æ€</th>
          <th>ä¼šå‘˜å¤©æ•°</th>
          <th>æœ‰æ•ˆæœŸè‡³</th>
          <th>ä½¿ç”¨è€…</th>
          <th>ä½¿ç”¨æ—¶é—´</th>
          <th>åˆ›å»ºæ—¶é—´</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div id="users" class="card">
    <h2 style="font-size:16px;">ç”¨æˆ·åˆ—è¡¨</h2>
    <div id="userCount"></div>
    <table id="userTable">
      <thead>
        <tr>
          <th>ID</th>
          <th>Email</th>
          <th>Plan</th>
          <th>åˆ°æœŸ</th>
          <th>æ³¨å†Œæ—¶é—´</th>
          <th>å‘½é¢˜æ•°</th>
          <th>äº‹ä»¶æ•°</th>
          <th>æ“ä½œ</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div id="topics" class="card" style="display:none;">
    <h2 style="font-size:16px;">ç”¨æˆ·å‘½é¢˜</h2>
    <table id="topicTable">
      <thead>
        <tr>
          <th>æ ‡é¢˜</th>
          <th>åˆ›å»ºæ—¶é—´</th>
          <th>äº‹ä»¶æ•°</th>
          <th>æŸ¥çœ‹äº‹ä»¶</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div id="events" class="card" style="display:none;">
    <h2 style="font-size:16px;">å‘½é¢˜äº‹ä»¶</h2>
    <table id="eventTable">
      <thead>
        <tr>
          <th>åç§°</th>
          <th>æ—¶é—´</th>
          <th>ç‰Œ</th>
          <th>è§£è¯»</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div id="prompts" class="card" style="display:none;">
    <h2 style="font-size:16px;">Prompt æ¨¡æ¿ç®¡ç†</h2>

    <div class="card" style="background:#0f172a;margin-bottom:12px;">
      <h3 style="font-size:14px;margin-bottom:8px;">åˆ›å»ºæ–° Prompt</h3>
      <div style="display:flex;flex-direction:column;gap:8px;">
        <input id="promptKey" type="text" placeholder="Key (å¦‚ tarot_event_reading)" style="width:100%;">
        <div class="flex">
          <select id="promptLanguage" style="width:100px;">
            <option value="zh">ä¸­æ–‡</option>
            <option value="en">English</option>
          </select>
          <select id="promptTriggerType" style="width:150px;">
            <option value="initial">é¦–æ¬¡è¯·æ±‚</option>
            <option value="event">äº‹ä»¶è¯·æ±‚</option>
          </select>
        </div>
        <div style="font-size:12px;color:#94a3b8;">é€‰æ‹©å˜é‡ï¼ˆå¤šé€‰ï¼‰ï¼š</div>
        <div style="display:flex;flex-wrap:wrap;gap:8px;font-size:12px;">
          <label><input type="checkbox" class="prompt-variable" value="question"> question (æˆ‘çš„é—®é¢˜)</label>
          <label><input type="checkbox" class="prompt-variable" value="baseline_cards"> baseline_cards (åŸºç¡€æŠ½ç‰Œ)</label>
          <label><input type="checkbox" class="prompt-variable" value="baseline_reading"> baseline_reading (åŸºç¡€è§£è¯»)</label>
          <label><input type="checkbox" class="prompt-variable" value="history"> history (å†å²äº‹ä»¶)</label>
          <label><input type="checkbox" class="prompt-variable" value="event_name"> event_name (äº‹ä»¶åç§°)</label>
          <label><input type="checkbox" class="prompt-variable" value="current_card"> current_card (å½“å‰æŠ½ç‰Œ)</label>
          <label><input type="checkbox" class="prompt-variable" value="reading_structure"> reading_structure (è§£è¯»ç»“æ„)</label>
        </div>
        <textarea id="promptTemplate" placeholder="æ¨¡æ¿å†…å®¹ï¼Œä½¿ç”¨ {{variable}} å ä½ç¬¦" style="width:100%;height:200px;font-family:monospace;font-size:12px;"></textarea>
        <button onclick="createPrompt()">åˆ›å»º Prompt</button>
      </div>
    </div>

    <div id="promptCount"></div>
    <table id="promptTable">
      <thead>
        <tr>
          <th>Key</th>
          <th>è¯­è¨€</th>
          <th>è§¦å‘æ—¶æœº</th>
          <th>å˜é‡</th>
          <th>çŠ¶æ€</th>
          <th>åˆ›å»ºæ—¶é—´</th>
          <th>æ“ä½œ</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div id="editPromptModal" class="card" style="display:none;position:fixed;top:50px;left:50%;transform:translateX(-50%);width:80%;max-width:800px;z-index:1000;max-height:90vh;overflow-y:auto;">
    <h3 style="font-size:14px;margin-bottom:8px;">ç¼–è¾‘ Prompt</h3>
    <div style="display:flex;flex-direction:column;gap:8px;">
      <input id="editPromptKey" type="text" placeholder="Key" style="width:100%;">
      <div class="flex">
        <select id="editPromptLanguage" style="width:100px;">
          <option value="zh">ä¸­æ–‡</option>
          <option value="en">English</option>
        </select>
        <select id="editPromptTriggerType" style="width:150px;">
          <option value="initial">é¦–æ¬¡è¯·æ±‚</option>
          <option value="event">äº‹ä»¶è¯·æ±‚</option>
        </select>
        <select id="editPromptIsActive" style="width:100px;">
          <option value="true">å¯ç”¨</option>
          <option value="false">ç¦ç”¨</option>
        </select>
      </div>
      <div style="font-size:12px;color:#94a3b8;">é€‰æ‹©å˜é‡ï¼ˆå¤šé€‰ï¼‰ï¼š</div>
      <div style="display:flex;flex-wrap:wrap;gap:8px;font-size:12px;">
        <label><input type="checkbox" class="edit-prompt-variable" value="question"> question</label>
        <label><input type="checkbox" class="edit-prompt-variable" value="baseline_cards"> baseline_cards</label>
        <label><input type="checkbox" class="edit-prompt-variable" value="baseline_reading"> baseline_reading</label>
        <label><input type="checkbox" class="edit-prompt-variable" value="history"> history</label>
        <label><input type="checkbox" class="edit-prompt-variable" value="event_name"> event_name</label>
        <label><input type="checkbox" class="edit-prompt-variable" value="current_card"> current_card</label>
        <label><input type="checkbox" class="edit-prompt-variable" value="reading_structure"> reading_structure</label>
      </div>
      <textarea id="editPromptTemplate" placeholder="æ¨¡æ¿å†…å®¹" style="width:100%;height:250px;font-family:monospace;font-size:12px;"></textarea>
      <div class="flex">
        <button onclick="savePrompt()" style="flex:1;">ä¿å­˜</button>
        <button onclick="closeEditModal()" style="flex:1;background:#334155;">å–æ¶ˆ</button>
      </div>
    </div>
  </div>

  <script>
    const api = async (path) => {
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      const headers = {
        'Authorization': 'Basic ' + btoa(`${email}:${password}`)
      };
      const response = await fetch(path, { headers });

      if (!response.ok) {
        const error = await response.text();
        throw new Error(`è¯·æ±‚å¤±è´¥ (${response.status}): ${error}`);
      }

      return response.json();
    };

    async function loadUsers() {
      try {
        const data = await api('/api/admin/users');
        const tbody = document.querySelector('#userTable tbody');
        tbody.innerHTML = '';
        document.getElementById('userCount').innerText = `æ€»ç”¨æˆ·ï¼š${data.total || 0}`;
        (data.users || []).forEach(u => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${u.id.substring(0, 8)}...</td>
            <td>${u.email || ''}</td>
            <td>${u.plan === 'member' ? 'ğŸŒŸ Pro' : 'âšª Free'}</td>
            <td>${u.membership_expires_at ? new Date(u.membership_expires_at).toLocaleDateString('zh-CN') : '-'}</td>
            <td>${u.created_at ? new Date(u.created_at).toLocaleDateString('zh-CN') : ''}</td>
            <td>${u.topic_count || 0}</td>
            <td>${u.event_count || 0}</td>
            <td>
              <button onclick="loadTopics('${u.id}')">å‘½é¢˜</button>
              ${u.plan === 'member' ? `<button onclick="downgradeUserConfirm('${u.id}')" style="background:#dc2626;">é™çº§</button>` : ''}
            </td>
          `;
          tbody.appendChild(tr);
        });
        // ç™»å½•æˆåŠŸåæ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯å’Œç”¨æˆ·åˆ—è¡¨
        document.getElementById('users').style.display = 'block';
        document.getElementById('codes').style.display = 'none';
        console.log('ç™»å½•æˆåŠŸï¼Œå·²åŠ è½½ç”¨æˆ·åˆ—è¡¨');
      } catch (error) {
        console.error('åŠ è½½å¤±è´¥:', error);
        alert('ç™»å½•å¤±è´¥ï¼š' + error.message + '\nè¯·æ£€æŸ¥é‚®ç®±å’Œå¯†ç æ˜¯å¦æ­£ç¡®');
        document.querySelector('#userTable tbody').innerHTML = '<tr><td colspan="8">ç™»å½•å¤±è´¥ï¼Œè¯·é‡æ–°è¾“å…¥æ­£ç¡®çš„é‚®ç®±å’Œå¯†ç </td></tr>';
      }
    }

    async function loadTopics(userId) {
      try {
        const data = await api(`/api/admin/users/${userId}/topics`);
        const tbody = document.querySelector('#topicTable tbody');
        tbody.innerHTML = '';
        (data.topics || []).forEach(t => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${t.title}</td>
            <td>${t.created_at || ''}</td>
            <td>${t.event_count || 0}</td>
            <td><button data-id="${t.id}">æŸ¥çœ‹</button></td>
          `;
          tr.querySelector('button').onclick = () => loadEvents(t.id);
          tbody.appendChild(tr);
        });
        document.getElementById('topics').style.display = 'block';
        document.getElementById('events').style.display = 'none';
      } catch (error) {
        console.error('åŠ è½½å‘½é¢˜å¤±è´¥:', error);
        alert('åŠ è½½å‘½é¢˜å¤±è´¥ï¼š' + error.message);
      }
    }

    async function loadEvents(topicId) {
      try {
        const data = await api(`/api/admin/topics/${topicId}/events`);
        const tbody = document.querySelector('#eventTable tbody');
        tbody.innerHTML = '';
        (data.events || []).forEach(e => {
          const cards = (e.cards || []).map(c => c.name || c.nameCn || '').join(', ');
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${e.name}</td>
            <td>${e.created_at || ''}</td>
            <td>${cards}</td>
            <td><pre>${e.reading || ''}</pre></td>
          `;
          tbody.appendChild(tr);
        });
        document.getElementById('events').style.display = 'block';
      } catch (error) {
        console.error('åŠ è½½äº‹ä»¶å¤±è´¥:', error);
        alert('åŠ è½½äº‹ä»¶å¤±è´¥ï¼š' + error.message);
      }
    }

    async function loadCodes() {
      try {
        const data = await api('/api/admin/codes');
        const tbody = document.querySelector('#codeTable tbody');
        tbody.innerHTML = '';

        const stats = { total: 0, active: 0, used: 0, expired: 0 };
        (data.codes || []).forEach(c => {
          stats.total++;
          stats[c.status]++;

          const statusText = {
            active: 'ğŸŸ¢ å¯ç”¨',
            used: 'ğŸ”´ å·²ä½¿ç”¨',
            expired: 'âš« å·²è¿‡æœŸ'
          }[c.status] || c.status;

          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td><code>${c.code}</code></td>
            <td>${statusText}</td>
            <td>${c.duration_days} å¤©</td>
            <td>${c.expires_at ? new Date(c.expires_at).toLocaleDateString('zh-CN') : 'æ°¸ä¹…'}</td>
            <td>${c.redeemed_by_email || '-'}</td>
            <td>${c.redeemed_at ? new Date(c.redeemed_at).toLocaleString('zh-CN') : '-'}</td>
            <td>${new Date(c.created_at).toLocaleString('zh-CN')}</td>
          `;
          tbody.appendChild(tr);
        });

        document.getElementById('codeCount').innerText =
          `æ€»è®¡ï¼š${stats.total} | å¯ç”¨ï¼š${stats.active} | å·²ä½¿ç”¨ï¼š${stats.used} | å·²è¿‡æœŸï¼š${stats.expired}`;

        document.getElementById('codes').style.display = 'block';
        document.getElementById('users').style.display = 'none';
        console.log('å…‘æ¢ç åŠ è½½æˆåŠŸ');
      } catch (error) {
        console.error('åŠ è½½å…‘æ¢ç å¤±è´¥:', error);
        alert('åŠ è½½å…‘æ¢ç å¤±è´¥ï¼š' + error.message);
      }
    }

    async function generateCodes() {
      try {
        const count = parseInt(document.getElementById('codeCount').value) || 1;
        const durationDays = parseInt(document.getElementById('codeDurationDays').value) || 30;
        const validDays = parseInt(document.getElementById('codeValidDays').value) || 365;

        if (count < 1 || count > 50) {
          alert('æ•°é‡å¿…é¡»åœ¨ 1-50 ä¹‹é—´');
          return;
        }

        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        const headers = {
          'Authorization': 'Basic ' + btoa(`${email}:${password}`),
          'Content-Type': 'application/json'
        };

        const response = await fetch('/api/admin/codes/generate', {
          method: 'POST',
          headers,
          body: JSON.stringify({ count, durationDays, validDays })
        });

        if (!response.ok) {
          throw new Error(`ç”Ÿæˆå¤±è´¥ (${response.status})`);
        }

        const data = await response.json();

        // æ˜¾ç¤ºç”Ÿæˆçš„å…‘æ¢ç 
        const generatedDiv = document.getElementById('generatedCodes');
        const codesList = document.getElementById('generatedCodesList');
        codesList.textContent = data.codes.join('\n');
        generatedDiv.style.display = 'block';

        alert(`æˆåŠŸç”Ÿæˆ ${data.codes.length} ä¸ªå…‘æ¢ç ï¼`);

        // é‡æ–°åŠ è½½åˆ—è¡¨
        loadCodes();
      } catch (error) {
        console.error('ç”Ÿæˆå…‘æ¢ç å¤±è´¥:', error);
        alert('ç”Ÿæˆå…‘æ¢ç å¤±è´¥ï¼š' + error.message);
      }
    }

    // Prompt ç®¡ç†ç›¸å…³å‡½æ•°
    let currentEditingPromptId = null;

    async function loadPrompts() {
      try {
        const data = await api('/api/admin/prompts');
        const tbody = document.querySelector('#promptTable tbody');
        tbody.innerHTML = '';

        document.getElementById('promptCount').innerText = `æ€»è®¡ï¼š${data.prompts?.length || 0} ä¸ªæ¨¡æ¿`;

        (data.prompts || []).forEach(p => {
          const triggerText = p.trigger_type === 'initial' ? 'é¦–æ¬¡è¯·æ±‚' : 'äº‹ä»¶è¯·æ±‚';
          const statusText = p.is_active ? 'ğŸŸ¢ å¯ç”¨' : 'âš« ç¦ç”¨';
          const variables = Array.isArray(p.variables) ? p.variables.join(', ') : 'æ— ';

          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td><code>${p.key}</code></td>
            <td>${p.language}</td>
            <td>${triggerText}</td>
            <td style="font-size:10px;">${variables}</td>
            <td>${statusText}</td>
            <td>${new Date(p.created_at).toLocaleString('zh-CN')}</td>
            <td>
              <button onclick="editPrompt('${p.id}')">ç¼–è¾‘</button>
              <button onclick="deletePromptConfirm('${p.id}')" style="background:#dc2626;">åˆ é™¤</button>
            </td>
          `;
          tbody.appendChild(tr);
        });

        document.getElementById('prompts').style.display = 'block';
        document.getElementById('users').style.display = 'none';
        document.getElementById('codes').style.display = 'none';
        console.log('Prompts åŠ è½½æˆåŠŸ');
      } catch (error) {
        console.error('åŠ è½½ Prompts å¤±è´¥:', error);
        alert('åŠ è½½ Prompts å¤±è´¥ï¼š' + error.message);
      }
    }

    async function createPrompt() {
      try {
        const key = document.getElementById('promptKey').value.trim();
        const language = document.getElementById('promptLanguage').value;
        const trigger_type = document.getElementById('promptTriggerType').value;
        const template = document.getElementById('promptTemplate').value;

        if (!key || !template) {
          alert('è¯·å¡«å†™ Key å’Œæ¨¡æ¿å†…å®¹');
          return;
        }

        // è·å–é€‰ä¸­çš„å˜é‡
        const variables = Array.from(document.querySelectorAll('.prompt-variable:checked')).map(cb => cb.value);

        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        const headers = {
          'Authorization': 'Basic ' + btoa(`${email}:${password}`),
          'Content-Type': 'application/json'
        };

        const response = await fetch('/api/admin/prompts', {
          method: 'POST',
          headers,
          body: JSON.stringify({ key, language, trigger_type, variables, template })
        });

        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.message || `åˆ›å»ºå¤±è´¥ (${response.status})`);
        }

        alert('Prompt åˆ›å»ºæˆåŠŸï¼');

        // æ¸…ç©ºè¡¨å•
        document.getElementById('promptKey').value = '';
        document.getElementById('promptTemplate').value = '';
        document.querySelectorAll('.prompt-variable').forEach(cb => cb.checked = false);

        // é‡æ–°åŠ è½½åˆ—è¡¨
        loadPrompts();
      } catch (error) {
        console.error('åˆ›å»º Prompt å¤±è´¥:', error);
        alert('åˆ›å»º Prompt å¤±è´¥ï¼š' + error.message);
      }
    }

    async function editPrompt(promptId) {
      try {
        const data = await api('/api/admin/prompts');
        const prompt = data.prompts.find(p => p.id === promptId);

        if (!prompt) {
          alert('æ‰¾ä¸åˆ°è¯¥ Prompt');
          return;
        }

        currentEditingPromptId = promptId;

        // å¡«å……è¡¨å•
        document.getElementById('editPromptKey').value = prompt.key;
        document.getElementById('editPromptLanguage').value = prompt.language;
        document.getElementById('editPromptTriggerType').value = prompt.trigger_type;
        document.getElementById('editPromptIsActive').value = prompt.is_active.toString();
        document.getElementById('editPromptTemplate').value = prompt.template;

        // è®¾ç½®å˜é‡å¤é€‰æ¡†
        document.querySelectorAll('.edit-prompt-variable').forEach(cb => {
          cb.checked = Array.isArray(prompt.variables) && prompt.variables.includes(cb.value);
        });

        // æ˜¾ç¤ºç¼–è¾‘æ¨¡æ€æ¡†
        document.getElementById('editPromptModal').style.display = 'block';
      } catch (error) {
        console.error('åŠ è½½ Prompt è¯¦æƒ…å¤±è´¥:', error);
        alert('åŠ è½½ Prompt è¯¦æƒ…å¤±è´¥ï¼š' + error.message);
      }
    }

    async function savePrompt() {
      try {
        if (!currentEditingPromptId) {
          alert('æ— æ•ˆçš„æ“ä½œ');
          return;
        }

        const key = document.getElementById('editPromptKey').value.trim();
        const language = document.getElementById('editPromptLanguage').value;
        const trigger_type = document.getElementById('editPromptTriggerType').value;
        const is_active = document.getElementById('editPromptIsActive').value === 'true';
        const template = document.getElementById('editPromptTemplate').value;

        if (!key || !template) {
          alert('è¯·å¡«å†™ Key å’Œæ¨¡æ¿å†…å®¹');
          return;
        }

        // è·å–é€‰ä¸­çš„å˜é‡
        const variables = Array.from(document.querySelectorAll('.edit-prompt-variable:checked')).map(cb => cb.value);

        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        const headers = {
          'Authorization': 'Basic ' + btoa(`${email}:${password}`),
          'Content-Type': 'application/json'
        };

        const response = await fetch(`/api/admin/prompts/${currentEditingPromptId}`, {
          method: 'PUT',
          headers,
          body: JSON.stringify({ key, language, trigger_type, variables, template, is_active })
        });

        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.message || `æ›´æ–°å¤±è´¥ (${response.status})`);
        }

        alert('Prompt æ›´æ–°æˆåŠŸï¼');

        closeEditModal();
        loadPrompts();
      } catch (error) {
        console.error('æ›´æ–° Prompt å¤±è´¥:', error);
        alert('æ›´æ–° Prompt å¤±è´¥ï¼š' + error.message);
      }
    }

    function closeEditModal() {
      document.getElementById('editPromptModal').style.display = 'none';
      currentEditingPromptId = null;
    }

    async function deletePromptConfirm(promptId) {
      if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ª Prompt å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚')) {
        return;
      }

      try {
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        const headers = {
          'Authorization': 'Basic ' + btoa(`${email}:${password}`)
        };

        const response = await fetch(`/api/admin/prompts/${promptId}`, {
          method: 'DELETE',
          headers
        });

        if (!response.ok) {
          throw new Error(`åˆ é™¤å¤±è´¥ (${response.status})`);
        }

        alert('Prompt åˆ é™¤æˆåŠŸï¼');
        loadPrompts();
      } catch (error) {
        console.error('åˆ é™¤ Prompt å¤±è´¥:', error);
        alert('åˆ é™¤ Prompt å¤±è´¥ï¼š' + error.message);
      }
    }

    // Analytics functions
    async function loadAnalytics() {
      try {
        const days = document.getElementById('analyticsRangeDays').value;
        const data = await api(`/api/admin/analytics?days=${days}`);

        // Update summary
        const summary = data.summary || {};
        document.getElementById('totalPageViews').innerText = summary.total_page_views || 0;
        document.getElementById('totalUniqueVisitors').innerText = summary.total_unique_visitors || 0;
        document.getElementById('totalBaselineReadings').innerText = summary.total_baseline_readings || 0;
        document.getElementById('totalEventReadings').innerText = summary.total_event_readings || 0;
        document.getElementById('totalNewUsers').innerText = summary.total_new_users || 0;
        document.getElementById('totalNewTopics').innerText = summary.total_new_topics || 0;

        // Update table
        const tbody = document.querySelector('#analyticsTable tbody');
        tbody.innerHTML = '';

        (data.analytics || []).forEach(row => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${new Date(row.date).toLocaleDateString('zh-CN')}</td>
            <td>${row.page_views || 0}</td>
            <td>${row.unique_visitors || 0}</td>
            <td>${row.baseline_readings || 0}</td>
            <td>${row.event_readings || 0}</td>
            <td>${row.new_users || 0}</td>
            <td>${row.new_topics || 0}</td>
          `;
          tbody.appendChild(tr);
        });

        document.getElementById('analytics').style.display = 'block';
        document.getElementById('users').style.display = 'none';
        document.getElementById('codes').style.display = 'none';
        document.getElementById('prompts').style.display = 'none';
        console.log('ç»Ÿè®¡æ•°æ®åŠ è½½æˆåŠŸ');
      } catch (error) {
        console.error('åŠ è½½ç»Ÿè®¡æ•°æ®å¤±è´¥:', error);
        alert('åŠ è½½ç»Ÿè®¡æ•°æ®å¤±è´¥ï¼š' + error.message);
      }
    }

    // Downgrade user function
    async function downgradeUserConfirm(userId) {
      if (!confirm('ç¡®å®šè¦å°†æ­¤ç”¨æˆ·é™çº§ä¸ºå…è´¹ç”¨æˆ·å—ï¼Ÿæ­¤æ“ä½œå°†æ¸…é™¤å…¶ä¼šå‘˜åˆ°æœŸæ—¶é—´ã€‚')) {
        return;
      }

      try {
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        const headers = {
          'Authorization': 'Basic ' + btoa(`${email}:${password}`),
          'Content-Type': 'application/json'
        };

        const response = await fetch(`/api/admin/users/${userId}/downgrade`, {
          method: 'POST',
          headers
        });

        if (!response.ok) {
          throw new Error(`é™çº§å¤±è´¥ (${response.status})`);
        }

        alert('ç”¨æˆ·é™çº§æˆåŠŸï¼');
        loadUsers();
      } catch (error) {
        console.error('é™çº§ç”¨æˆ·å¤±è´¥:', error);
        alert('é™çº§ç”¨æˆ·å¤±è´¥ï¼š' + error.message);
      }
    }
  </script>
</body>
</html>
